#!/bin/bash

set -o errexit

export LC_ALL=en_US.utf8
export LANGUAGE=en_US.utf8
export LANG=en_US.utf8

ROCKET_CHAT_VERSION="3.9.4"

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

echo "* Get latest"
apt-get -y update
apt-get -y upgrade
apt-get -y dist-upgrade

echo "* Setup nginx"
mv /usr/local/var/tmp/rocketchat /etc/nginx/sites-available/rocketchat
ln -nfs /etc/nginx/sites-available/rocketchat /etc/nginx/sites-enabled/rocketchat
mkdir -p /etc/nginx/ssl
chmod 0500 /etc/nginx/ssl
/usr/local/bin/ssl-selfsigned.sh -d /etc/nginx/ssl -f rocketchat
# service nginx restart

echo "* Setup node"
# http://linuxbsdos.com/2017/06/26/how-to-install-node-js-lts-on-debian-9-stretch/
/usr/local/var/tmp/setup_6.x
apt -qq install nodejs
npm install -g inherits n
n 12.18.4
# ensure that we are using the right node version
export PATH="/usr/local/bin:$PATH"
npm install npm@latest -g

# curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
# echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
# sudo apt-get update && sudo apt-get install yarn

echo "* Setup mongodb"
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4 || true
echo "deb http://repo.mongodb.org/apt/debian stretch/mongodb-org/4.0 main" | tee /etc/apt/sources.list.d/mongodb-org-4.0.list || true
apt-get -y update
apt-get -y install mongodb-org
sed -i "s/^#  engine:/  engine: mmapv1/" /etc/mongod.conf
sed -i "s/^#replication:/replication:\n  replSetName: rs01/" /etc/mongod.conf

echo "* Setup rocket-chat"
addgroup rocket
adduser --disabled-password --system --quiet --home /var/www/rocket --shell /bin/bash rocket
adduser rocket rocket
mkdir -p /var/www/rocket
curl -L -s "https://download.qutic.com/src/rocket-chat/rocket.chat-${ROCKET_CHAT_VERSION}.tgz" | tar xz -C /var/www/rocket --strip-components=1
chown -R rocket:rocket /var/www/rocket
su - rocket -c "cd programs/server && npm install"

echo "* Setup rocket-chat service"
cp /usr/local/var/tmp/rocketchat_service /etc/systemd/system/rocketchat.service

echo "* Setup hubot"
addgroup hubot
adduser --disabled-password --system --quiet --home /var/www/hubot --shell /bin/bash hubot
adduser hubot hubot
mkdir -p /var/www/hubot
su - hubot -c "git clone https://github.com/RocketChat/hubot-rocketchat-boilerplate"
# https://github.com/RocketChat/hubot-rocketchat/issues/338#issuecomment-734128312
sed -i \
    -e "s|rocketchat/hubot-rocketchat|git+https://github.com/DeviaVir/hubot-rocketchat.git|" \
    /var/www/hubot/hubot-rocketchat-boilerplate/package.json
# install dependencies
su - hubot -c "cd hubot-rocketchat-boilerplate; npm install"
su - hubot -c "cd hubot-rocketchat-boilerplate; npm install --save hubot-rundeck"
su - hubot -c "cd hubot-rocketchat-boilerplate; npm install --save hubot-rememberto"
cp /usr/local/var/tmp/external-scripts.json /var/www/hubot/hubot-rocketchat-boilerplate/external-scripts.json
cp /usr/local/var/tmp/hubot_service /etc/systemd/system/hubot.service

echo "* Ensure bootstrap will run next time"
rm -rf /var/lib/bootstrap

cat >> /root/.bash_history << EOF
nano /etc/systemd/system/rocketchat.service
systemctl daemon-reload
service rocketchat restart
EOF

echo "* Cleaning up."
apt-get -y purge git make gcc g++ build-essential
rm -rf /usr/local/var/tmp/*
rm /var/log/syslog || true
touch /var/log/syslog || true
rm /root/customize
history -c
